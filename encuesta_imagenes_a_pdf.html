<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Señales → PDF (iPhone friendly)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root { --bg:#0b1324; --panel:#0f1a33; --ink:#eaf1ff; --muted:#9fb2d8; --brand:#4da3ff; --ok:#0dd37d; --err:#ff5d5d; }
    * { box-sizing: border-box }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 900px; margin: 24px auto; padding: 16px; }
    .card { background: var(--panel); border:1px solid #1b2b52; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 12px; font-size: 1.35rem; }
    .grid { display: grid; gap: 14px; }
    @media (min-width:700px){ .grid { grid-template-columns: repeat(3, 1fr); } }
    .item { background: rgba(255,255,255,.02); border:1px dashed #31518f; border-radius: 14px; padding: 12px; }
    .item h2 { margin: 0 0 8px; font-size: 0.98rem; color: var(--brand); }
    .uploader { display: grid; gap: 8px; }
    .btn { appearance:none; border:0; border-radius: 12px; padding: 12px; font-weight:600; cursor:pointer; text-align:center; display:inline-block; }
    .btn.sec { background:#1a2b52; color: var(--ink); }
    .btn.pri { background: var(--brand); color: #00142a; }
    .btn.ghost { background: transparent; border:1px solid #2a4480; color: var(--muted); }
    .preview { width: 100%; aspect-ratio: 4/3; background:#091227; border:1px solid #1a2b52; border-radius: 10px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .preview img { max-width:100%; max-height:100%; display:block; }
    .toolbar { display:flex; gap:10px; flex-wrap: wrap; margin-top: 14px; }
    .hint { color: var(--muted); font-size: .9rem; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    /* inputs de archivo visibles para iOS (no display:none) pero discretos */
    input[type=file] { width:1px; height:1px; opacity:0; position:absolute; left:-9999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Imágenes de señales → PDF</h1>
      <p class="hint">En iPhone, usa los botones azules (son <b>labels</b>) para abrir cámara/galería. Luego toca <b>Guardar PDF</b>.</p>

      <div class="grid">
        <!-- Ítem 1 -->
        <div class="item" data-key="sr30_30">
          <h2>Señal SR-30(30)</h2>
          <div class="uploader">
            <div class="preview" id="prev-sr30_30"><span class="hint">Sin imagen</span></div>
            <input type="file" accept="image/*" capture="environment" id="file-sr30_30" />
            <label class="btn sec" for="file-sr30_30">Elegir / Tomar foto</label>
            <button type="button" class="btn ghost" data-action="clear" data-for="sr30_30">Quitar</button>
            <small class="hint" id="info-sr30_30"></small>
          </div>
        </div>

        <!-- Ítem 2 -->
        <div class="item" data-key="sr30_50">
          <h2>Señal SR-30(50)</h2>
          <div class="uploader">
            <div class="preview" id="prev-sr30_50"><span class="hint">Sin imagen</span></div>
            <input type="file" accept="image/*" capture="environment" id="file-sr30_50" />
            <label class="btn sec" for="file-sr30_50">Elegir / Tomar foto</label>
            <button type="button" class="btn ghost" data-action="clear" data-for="sr30_50">Quitar</button>
            <small class="hint" id="info-sr30_50"></small>
          </div>
        </div>

        <!-- Ítem 3 -->
        <div class="item" data-key="trabajos">
          <h2>Señal Trabajos en Vía</h2>
          <div class="uploader">
            <div class="preview" id="prev-trabajos"><span class="hint">Sin imagen</span></div>
            <input type="file" accept="image/*" capture="environment" id="file-trabajos" />
            <label class="btn sec" for="file-trabajos">Elegir / Tomar foto</label>
            <button type="button" class="btn ghost" data-action="clear" data-for="trabajos">Quitar</button>
            <small class="hint" id="info-trabajos"></small>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <button type="button" class="btn pri" id="savePdfBtn" disabled>Guardar PDF</button>
        <span id="status" class="hint"></span>
      </div>
    </div>
  </div>

  <script>
    const labels = {
      "sr30_30": "Señal SR-30(30)",
      "sr30_50": "Señal SR-30(50)",
      "trabajos": "Señal Trabajos en Vía"
    };
    const cfg = {
      "sr30_30": { file: "file-sr30_30", prev:"prev-sr30_30", info:"info-sr30_30" },
      "sr30_50": { file: "file-sr30_50", prev:"prev-sr30_50", info:"info-sr30_50" },
      "trabajos": { file: "file-trabajos", prev:"prev-trabajos", info:"info-trabajos" },
    };
    const state = { sr30_30:null, sr30_50:null, trabajos:null };

    function $(id){ return document.getElementById(id); }
    function setStatus(t, cls=""){ const s=$("status"); s.textContent=t; s.className="hint "+cls; }

    // Limpiar
    document.querySelectorAll('[data-action="clear"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const key = b.getAttribute('data-for');
        state[key] = null;
        $(cfg[key].prev).innerHTML = '<span class="hint">Sin imagen</span>';
        $(cfg[key].info).textContent = '';
        $(cfg[key].file).value = '';
        validateReady();
      }, {passive:true});
    });

    // Cargar imagen (gesto real: label for=input)
    Object.keys(cfg).forEach(key=>{
      $(cfg[key].file).addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        if(!file.type.startsWith('image/')) { setStatus('El archivo no es una imagen','err'); return; }

        setStatus('Procesando imagen…');
        try{
          const dataURL = await readAndResize(file, 2200, 2200);
          state[key] = { dataURL, name:file.name };
          const img = new Image();
          img.onload = ()=>{
            $(cfg[key].prev).innerHTML = '';
            $(cfg[key].prev).appendChild(img);
            $(cfg[key].info).textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
            setStatus('Imagen cargada','ok');
            validateReady();
          };
          img.alt = labels[key];
          img.src = dataURL;
        }catch(err){
          console.error(err);
          setStatus('No se pudo procesar la imagen','err');
        }
      }, {passive:true});
    });

    function validateReady(){
      const ok = state.sr30_30 && state.sr30_50 && state.trabajos;
      $("savePdfBtn").disabled = !ok;
      return ok;
    }

    // Redimensiona a JPEG DataURL
    function readAndResize(file, maxW=2200, maxH=2200){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>{
          const img = new Image();
          img.onload = ()=>{
            let w = img.naturalWidth, h = img.naturalHeight;
            const r = Math.min(maxW/w, maxH/h, 1);
            const cw = Math.round(w*r), ch=Math.round(h*r);
            const canvas = document.createElement('canvas');
            canvas.width=cw; canvas.height=ch;
            const ctx=canvas.getContext('2d');
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,cw,ch);
            ctx.drawImage(img,0,0,cw,ch);
            resolve(canvas.toDataURL('image/jpeg', 0.9));
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Guardar PDF (con fallback iOS)
    document.getElementById('savePdfBtn').addEventListener('click', async ()=>{
      if(!validateReady()){ setStatus('Faltan imágenes','err'); return; }
      setStatus('Generando PDF…');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margenX = 12, margenY = 14;
      const anchoImagen = pageW - margenX*2;

      async function addSection(titulo, dataURL){
        const y0 = margenY;
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text(titulo, margenX, y0);
        const img = await loadImage(dataURL);
        const ow = img.naturalWidth, oh = img.naturalHeight;
        const escala = anchoImagen / ow;
        let alto = oh * escala;
        const espacio = pageH - (y0+6) - margenY;
        if (alto > espacio) { const r = espacio/alto; alto *= r; }
        doc.addImage(dataURL, 'JPEG', margenX, y0+6, anchoImagen, alto);
      }

      try{
        doc.setProperties({ title:"Reporte de Señales" });
        await addSection('Señal SR-30(30)', state.sr30_30.dataURL);
        doc.addPage();
        await addSection('Señal SR-30(50)', state.sr30_50.dataURL);
        doc.addPage();
        await addSection('Señal Trabajos en Vía', state.trabajos.dataURL);

        const filename = `senales_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;

        // 1) Intento estándar
        try {
          doc.save(filename);
          setStatus('PDF guardado ✔', 'ok');
          return;
        } catch(_) {}

        // 2) iOS Fallback: Blob + Share/abrir
        const blob = doc.output('blob');
        const blobUrl = URL.createObjectURL(blob);

        // intentar share sheet si está disponible
        if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, {type:'application/pdf'})] })) {
          try {
            await navigator.share({ files: [new File([blob], filename, {type:'application/pdf'})] });
            setStatus('Compartido ✔', 'ok');
            URL.revokeObjectURL(blobUrl);
            return;
          } catch (_) { /* si cancela, seguimos abajo */ }
        }

        // abrir en nueva pestaña (iOS suele mostrar visor con opción “Compartir”/“Guardar en Archivos”)
        const a = document.createElement('a');
        a.href = blobUrl; a.target = '_blank'; a.rel = 'noopener';
        // a.download se ignora en iOS, pero lo dejamos por si otros navegadores
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setStatus('Abierto el PDF, usa Compartir/Guardar', 'ok');

        // liberar URL después de un rato
        setTimeout(()=>URL.revokeObjectURL(blobUrl), 60000);
      }catch(e){
        console.error(e);
        setStatus('No se pudo generar el PDF','err');
      }
    }, {passive:false});

    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = ()=>resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }
  </script>
</body>
</html>
