<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Señales → PDF (PWA)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1324">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <!-- jsPDF (se cachea con el Service Worker tras la primera visita online) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root { --bg:#0b1324; --panel:#0f1a33; --ink:#eaf1ff; --muted:#9fb2d8; --brand:#4da3ff; --ok:#0dd37d; --err:#ff5d5d; }
    * { box-sizing: border-box }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 900px; margin: 24px auto; padding: 16px; }
    .card { background: var(--panel); border:1px solid #1b2b52; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 12px; font-size: 1.35rem; }
    .grid { display: grid; gap: 14px; }
    @media (min-width:700px){ .grid { grid-template-columns: repeat(3, 1fr); } }
    .item { background: rgba(255,255,255,.02); border:1px dashed #31518f; border-radius: 14px; padding: 12px; }
    .item h2 { margin: 0 0 8px; font-size: 0.98rem; color: var(--brand); }
    .uploader { display: grid; gap: 8px; }
    .btn { appearance:none; border:0; border-radius: 12px; padding: 12px; font-weight:600; cursor:pointer; text-align:center; display:inline-block; }
    .btn.sec { background:#1a2b52; color: var(--ink); }
    .btn.pri { background: var(--brand); color: #00142a; }
    .btn.ghost { background: transparent; border:1px solid #2a4480; color: var(--muted); }
    .preview { width: 100%; aspect-ratio: 4/3; background:#091227; border:1px solid #1a2b52; border-radius: 10px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .preview img { max-width:100%; max-height:100%; display:block; }
    .toolbar { display:flex; gap:10px; flex-wrap: wrap; margin-top: 14px; }
    .hint { color: var(--muted); font-size: .9rem; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    input[type=file] { width:1px; height:1px; opacity:0; position:absolute; left:-9999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Imágenes de señales → PDF</h1>
      <p class="hint">
        Abre con HTTPS para que iPhone permita ubicación. Al cargar cada foto se estampa <b>fecha/hora</b> y <b>lat/lon</b> en la imagen.
        Tras la primera visita en línea, podrás usarla <b>sin conexión</b> (PWA).
      </p>

      <div class="grid">
        <!-- Ítem 1 -->
        <div class="item" data-key="sr30_30">
          <h2>Señal SR-30(30)</h2>
          <div class="uploader">
            <div class="preview" id="prev-sr30_30"><span class="hint">Sin imagen</span></div>
            <input type="file" accept="image/*" capture="environment" id="file-sr30_30" />
            <label class="btn sec" for="file-sr30_30">Elegir / Tomar foto</label>
            <button type="button" class="btn ghost" data-action="clear" data-for="sr30_30">Quitar</button>
            <small class="hint" id="info-sr30_30"></small>
          </div>
        </div>

        <!-- Ítem 2 -->
        <div class="item" data-key="sr30_50">
          <h2>Señal SR-30(50)</h2>
          <div class="uploader">
            <div class="preview" id="prev-sr30_50"><span class="hint">Sin imagen</span></div>
            <input type="file" accept="image/*" capture="environment" id="file-sr30_50" />
            <label class="btn sec" for="file-sr30_50">Elegir / Tomar foto</label>
            <button type="button" class="btn ghost" data-action="clear" data-for="sr30_50">Quitar</button>
            <small class="hint" id="info-sr30_50"></small>
          </div>
        </div>

        <!-- Ítem 3 -->
        <div class="item" data-key="trabajos">
          <h2>Señal Trabajos en Vía</h2>
          <div class="uploader">
            <div class="preview" id="prev-trabajos"><span class="hint">Sin imagen</span></div>
            <input type="file" accept="image/*" capture="environment" id="file-trabajos" />
            <label class="btn sec" for="file-trabajos">Elegir / Tomar foto</label>
            <button type="button" class="btn ghost" data-action="clear" data-for="trabajos">Quitar</button>
            <small class="hint" id="info-trabajos"></small>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <button type="button" class="btn pri" id="savePdfBtn" disabled>Guardar PDF</button>
        <span id="status" class="hint"></span>
      </div>
    </div>
  </div>

  <script>
    // ====== PWA: registrar Service Worker ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }

    const labels = {
      "sr30_30": "Señal SR-30(30)",
      "sr30_50": "Señal SR-30(50)",
      "trabajos": "Señal Trabajos en Vía"
    };
    const cfg = {
      "sr30_30": { file: "file-sr30_30", prev:"prev-sr30_30", info:"info-sr30_30" },
      "sr30_50": { file: "file-sr30_50", prev:"prev-sr30_50", info:"info-sr30_50" },
      "trabajos": { file: "file-trabajos", prev:"prev-trabajos", info:"info-trabajos" },
    };
    const state = { sr30_30:null, sr30_50:null, trabajos:null };

    function $(id){ return document.getElementById(id); }
    function setStatus(t, cls=""){ const s=$("status"); s.textContent=t; s.className="hint "+cls; }

    // ===== Utilidades =====
    function fmt2(n){ return n<10 ? "0"+n : ""+n; }
    function formatDateTime(d){
      const Y=d.getFullYear(), M=fmt2(d.getMonth()+1), D=fmt2(d.getDate());
      const h=fmt2(d.getHours()), m=fmt2(d.getMinutes()), s=fmt2(d.getSeconds());
      return `${Y}-${M}-${D} ${h}:${m}:${s}`;
    }
    function formatCoords(lat, lon, acc){
      const ll = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
      return acc!=null ? `${ll} (±${Math.round(acc)} m)` : ll;
    }

    async function getGeoOnce(timeout=12000){
      if (!('geolocation' in navigator)) return null;
      return new Promise((resolve)=>{
        const opt = { enableHighAccuracy:true, maximumAge:0, timeout };
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve({
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            acc: pos.coords.accuracy ?? null,
            ts: new Date(pos.timestamp)
          }),
          (_)=> resolve(null),
          opt
        );
      });
    }

    async function loadBitmapWithOrientation(file){
      if ('createImageBitmap' in window) {
        try {
          const bmp = await createImageBitmap(file, { imageOrientation: 'from-image' });
          return { type:'bitmap', bmp, width:bmp.width, height:bmp.height };
        } catch(_) {}
      }
      const dataURL = await fileToDataURL(file);
      const img = await loadImage(dataURL);
      return { type:'image', img, width:img.naturalWidth, height:img.naturalHeight, dataURL };
    }
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
    function loadImage(src){
      return new Promise((resolve,reject)=>{
        const im = new Image();
        im.onload = ()=> resolve(im);
        im.onerror = reject;
        im.src = src;
      });
    }

    async function renderStampedImage(file, overlayLines, maxW=2200, maxH=2200){
      const src = await loadBitmapWithOrientation(file);
      const r = Math.min(maxW/src.width, maxH/src.height, 1);
      const cw = Math.round(src.width * r);
      const ch = Math.round(src.height * r);
      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,cw,ch);
      if (src.type === 'bitmap') ctx.drawImage(src.bmp, 0, 0, cw, ch);
      else ctx.drawImage(src.img, 0, 0, cw, ch);

      const pad = Math.max(10, Math.round(cw*0.015));
      const fontSize = Math.max(14, Math.round(cw*0.028));
      ctx.font = `600 ${fontSize}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = 'bottom';

      const lines = overlayLines.filter(Boolean);
      const widths = lines.map(t=> ctx.measureText(t).width);
      const maxTextW = widths.length ? Math.max(...widths) : 0;
      const lineH = Math.round(fontSize * 1.2);
      const boxW = Math.min(cw - pad*2, maxTextW + pad*2);
      const boxH = lineH * lines.length + pad*1.2;

      const x = pad, y = ch - pad;
      ctx.fillStyle = "rgba(0,0,0,0.42)";
      ctx.fillRect(x - pad*0.6, y - boxH, boxW + pad*0.6, boxH);

      ctx.fillStyle = "#ffffff";
      lines.forEach((t, i)=>{
        ctx.fillText(t, x, y - (boxH - lineH*(i+1)) );
      });

      return canvas.toDataURL('image/jpeg', 0.9);
    }

    // Limpiar
    document.querySelectorAll('[data-action="clear"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const key = b.getAttribute('data-for');
        state[key] = null;
        $(cfg[key].prev).innerHTML = '<span class="hint">Sin imagen</span>';
        $(cfg[key].info).textContent = '';
        $(cfg[key].file).value = '';
        validateReady();
      }, {passive:true});
    });

    // Carga/estampa por foto
    Object.keys(cfg).forEach(key=>{
      $(cfg[key].file).addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        if(!file.type.startsWith('image/')) { setStatus('El archivo no es una imagen','err'); return; }

        setStatus('Obteniendo ubicación…');
        const geo = await getGeoOnce();
        const now = new Date();
        const timeStr = formatDateTime(now);
        const coordStr = geo ? formatCoords(geo.lat, geo.lon, geo.acc) : 'Ubicación: no disponible';
        const lines = [ timeStr, coordStr ];

        setStatus('Procesando imagen…');
        try{
          const stamped = await renderStampedImage(file, lines, 2200, 2200);
          state[key] = { dataURL: stamped, name:file.name, meta:{ time: now, geo } };
          const img = new Image();
          img.onload = ()=>{
            $(cfg[key].prev).innerHTML = '';
            $(cfg[key].prev).appendChild(img);
            $(cfg[key].info).textContent = `${file.name} — ${timeStr}${geo ? ` — ${coordStr}` : ''}`;
            setStatus('Imagen lista','ok');
            validateReady();
          };
          img.alt = labels[key];
          img.src = stamped;
        }catch(err){
          console.error(err);
          setStatus('No se pudo procesar la imagen','err');
        }
      }, {passive:true});
    });

    function validateReady(){
      const ok = state.sr30_30 && state.sr30_50 && state.trabajos;
      $("savePdfBtn").disabled = !ok;
      return ok;
    }

    // PDF + iOS fallback
    document.getElementById('savePdfBtn').addEventListener('click', async ()=>{
      if(!validateReady()){ setStatus('Faltan imágenes','err'); return; }
      setStatus('Generando PDF…');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margenX = 12, margenY = 14;
      const anchoImagen = pageW - margenX*2;

      async function addSection(titulo, dataURL){
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text(titulo, margenX, margenY);
        const im = await loadImage(dataURL);
        const ow=im.naturalWidth, oh=im.naturalHeight;
        const escala = anchoImagen / ow;
        let alto = oh * escala;
        const espacio = pageH - (margenY+6) - margenY;
        if (alto > espacio) { const r = espacio/alto; alto *= r; }
        doc.addImage(dataURL, 'JPEG', margenX, margenY+6, anchoImagen, alto);
      }

      try{
        doc.setProperties({ title:"Reporte de Señales" });
        await addSection('Señal SR-30(30)', state.sr30_30.dataURL);
        doc.addPage();
        await addSection('Señal SR-30(50)', state.sr30_50.dataURL);
        doc.addPage();
        await addSection('Señal Trabajos en Vía', state.trabajos.dataURL);

        const filename = `senales_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;

        try { doc.save(filename); setStatus('PDF guardado ✔','ok'); return; } catch(_) {}

        const blob = doc.output('blob');
        const file = new File([blob], filename, { type: 'application/pdf' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try { await navigator.share({ files:[file], title:'Reporte de Señales' }); setStatus('Compartido ✔','ok'); return; } catch(_) {}
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.target='_blank'; a.rel='noopener'; a.download=filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setStatus('Abierto el PDF, usa Compartir/Guardar','ok');
        setTimeout(()=>URL.revokeObjectURL(url), 60000);
      }catch(e){
        console.error(e);
        setStatus('No se pudo generar el PDF','err');
      }
    });
  </script>
</body>
</html>
